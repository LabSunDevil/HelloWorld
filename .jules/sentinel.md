## 2024-02-14 - [Second-Order SQL Injection in Recommendations]
**Vulnerability:** Found a Second-Order SQL Injection vulnerability in the `/api/recommendations` endpoint. The `watchedVideoIds` derived from the `views` table were directly concatenated into a SQL query string (`AND id NOT IN (${watchedVideoIds.join(',')})`). Because SQLite allows strings in INTEGER columns and input validation on `views` insertion was insufficient (or reliance on DB state was misplaced), a malicious payload in the `views` table could be injected into the recommendation query.
**Learning:** Never trust data from the database to be safe for direct string concatenation in SQL queries. "Second Order" injection occurs when the attack payload is stored first and executed later. Even "internal" data flows must use parameterized queries.
**Prevention:** Always use parameterized queries (e.g., `?` placeholders) for ALL dynamic values in SQL, including lists in `IN` clauses. Do not rely on previous validation or database constraints (especially in flexible schemas like SQLite) to guarantee data safety.
